{% extends 'layout.html' %}
{% load staticfiles %}
{% load static %}
{% load i18n %}
{% load l10n %}



{% block sidebar %}

    <!-- Intro -->
    <section id="intro">
        <header>
            <h2>Mappa degli eventi</h2>

            {#            <p>Another fine responsive site template by <a href="http://html5up.net">HTML5#}
            {#                UP</a></p>#}
        </header>
    </section>

    <!-- Mini Posts -->
    <section>
        <div class="mini-posts">
            {% for event in events %}
                <!-- Mini Post -->
                <article class="mini-post" id="event_id_{{ event.pk }}">
                    <header>
                        <h3><a href="#">{{ event.title }}</a></h3>
                        <time class="published"
                              datetime="{{ event.start_date|date:"SHORT_DATE_FORMAT" }}">{{ event.start_date }}</time>
                        <p>{{ event.city }}</p>
                    </header>
                </article>

            {% endfor %}
        </div>
    </section>

{% endblock sidebar %}

{% block main %}

    <!-- Post -->
    <article class="post">

        <div id="map-canvas" style="height: 750px"></div>
        <footer>
            <ul class="stats">
                <li><a href="#">Eventi</a></li>
                <li><a href="#" class="icon fa-map-marker">{{ events.count }}</a></li>
            </ul>
        </footer>
    </article>

    {% for event in events %}
        <div id="eventModal_{{ event.pk }}" class="modal fade" tabindex="-1" role="dialog" style="margin-top:50px">
            <div class="modal-dialog">

                <!-- Post -->
                <article class="post">
                    <header>
                        <div class="title">
                            <h2><a href="#">{{ event.title }}</a></h2>

                            <p>{{ event.place_address }}</p>

                            <p>
                                <time class="published"
                                      datetime="{{ event.start_date|date:"SHORT_DATE_FORMAT" }}">{{ event.start_date }}</time>
                            </p>
                        </div>
                    </header>

                    <p>{{ event.text }}</p>
                    <footer>

                        <div id="map-canvas_{{ event.pk }}" style="height: 300px;width: 500px;"></div>
                    </footer>
                </article>
            </div>
        </div>

    {% endfor %}

{% endblock main %}

{% block headscripts %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'editorial/css/map.css' %}"/>
{% endblock headscripts %}

{% block bottomscripts %}
    {{ block.super }}

    <script type="text/javascript" src="{% static 'bootstrap-3.3.6-dist/js/bootstrap.min.js' %}"></script>
    <script type="text/javascript"
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAAFmqO4VtFQEUTpEXKzPxrFtBAzGOpzpQ&sensor=false"></script>
    <script type="text/javascript" src="{% static 'editorial/events/maps/js/markerclusterer_compiled.js' %}"></script>

    <!-- Map Icons -->
    <link rel="stylesheet" type="text/css" href="{% static 'map-icons-master/dist/css/map-icons.css' %}">
    <script type="text/javascript" src="{% static 'map-icons-master/dist/js/map-icons.js' %}"></script>

    <script type="text/javascript">

        var init_event_map = function (id) {
            var eventApi = "/editorial/api/events/" + id + "/";
            $.getJSON(eventApi, {
                        format: "json"
                    })
                    .done(function (data) {

                        var mapOptions = {
                            zoom: 8
                        };
                        var map = new google.maps.Map(document.getElementById("map-canvas_" + data.id), mapOptions);
                        var point = new google.maps.LatLng(data.geo_lat, data.geo_long);

                        new Marker({
                            map: map,
                            position: point,
                            icon: {
                                path: MAP_PIN,
                                fillColor: data.color,
                                fillOpacity: 1,
                                strokeColor: '',
                                strokeWeight: 0
                            },
                            title: '{{mark.title}}',
                            map_icon_label: '<span class="map-icon map-icon-postal-code-prefix"></span>'
                        });

                        map.setCenter(point);
                        map.setZoom(16);
                    });

        };


        function initialize() {

            var mapOptions = {
                zoom: 6
            };
            var map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
            var bounds = new google.maps.LatLngBounds();

            var markers = [];

            {% for mark in events %}
                var point = new google.maps.LatLng({{mark.geo_lat|safe}}, {{mark.geo_long|safe}});

                var marker_{{ mark.id }} = new Marker({
                    map: map,
                    position: point,
                    icon: {
                        path: MAP_PIN,
                        fillColor: '{{ mark.color }}',
                        fillOpacity: 1,
                        strokeColor: '',
                        strokeWeight: 0
                    },
                    title: '{{mark.title}}',
                    map_icon_label: '<span class="map-icon map-icon-postal-code-prefix"></span>'
                });

                {#                var marker_{{ mark.id }} = new google.maps.Marker({#}
                {#                    position: point,#}
                {#                    map: map,#}
                {#                    title: '{{mark.username}}',#}
                {#                    icon: '{% static 'editorial/events/maps/images/marker_small.png' %}'#}
                {#                });#}
                bounds.extend(marker_{{ mark.id }}.position);
                google.maps.event.addListener(marker_{{ mark.id }}, 'click', function () {
                    map.setCenter(marker_{{ mark.id }}.getPosition());
                    map.setZoom(9);
                    $('#eventModal_{{ mark.pk }}').modal('show');

                    $('#eventModal_{{ mark.pk }}').on('shown.bs.modal', function (e) {
                        init_event_map({{ mark.pk }});
                    });
                });
                                google.maps.event.addListener(marker_{{ mark.id }}, 'mouseover', function () {
                                    $("#event_id_{{ mark.pk }}").addClass('map-event-zoom-effect');
                                });
                                google.maps.event.addListener(marker_{{ mark.id }}, 'mouseout', function () {
                                    $("#event_id_{{ mark.pk }}").removeClass('map-event-zoom-effect');
                                });
                markers.push(marker_{{ mark.id }});
            {% endfor %}

            var mcOptions = {
                gridSize: 80,
                maxZoom: 10,
                styles: [
                    {
                        url: '{% static 'editorial/events/maps/images/cluster_small.png' %}',
                        textColor: '#FFFFFF',
                        width: 96,
                        height: 48,
                        anchor: [6, 40],
                        textSize: 12,
                    },
                    {
                        url: '{% static 'editorial/events/maps/images/cluster_small.png' %}',
                        textColor: '#FFFFFF',
                        width: 92,
                        height: 48,
                        anchor: [6, 36],
                        textSize: 12,
                    }]
            };
            var mc = new MarkerClusterer(map, markers, mcOptions);

            //now fit the map to the newly inclusive bounds
            map.fitBounds(bounds);
        }
        google.maps.event.addDomListener(window, 'load', initialize);

    </script>
{% endblock %}